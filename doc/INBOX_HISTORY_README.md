# Входящие - История задач

## Описание

Раздел "Входящие" отображает объединённую историю изменений по всем задачам в системе.

## Функциональность

### Отображение истории

- **Хронологический порядок**: Последние изменения отображаются сверху
- **Детальная информация**: Для каждого события показывается:
  - Название задачи
  - Текущий статус задачи
  - Описание действия (кто и что изменил)
  - Проект, приоритет, исполнитель (если есть)
  - Время изменения (относительное: "5 мин. назад", "2 ч. назад", и т.д.)

### Визуальное выделение

#### 1. Назначенные мне задачи

- **Условие**: Действие типа `assigned` или `executor_changed`, где исполнитель - текущий пользователь
- **Оформление**: Синий фон (`bg-blue-50`), синяя граница, бейдж "Назначено вам"
- **Иконка**: 👤

#### 2. Завершённые задачи

- **Условие**: Действие типа `status_changed` со статусами Done/Completed/Выполнено/Завершено
- **Оформление**: Зелёный фон (`bg-green-50`), зелёная граница, бейдж "Завершено"
- **Иконка**: ✅

### Типы действий и иконки

| Тип действия | Иконка | Описание |
|--------------|--------|----------|
| `created` | ➕ | Создание задачи |
| `status_changed` | 🔄 | Изменение статуса |
| `assigned` / `executor_changed` | 👤 | Назначение/изменение исполнителя |
| `priority_changed` | ⚡ | Изменение приоритета |
| `deadline_changed` | 📅 | Изменение дедлайна |
| `startdate_changed` | 🕒 | Изменение даты начала |
| `name_changed` | ✏️ | Изменение названия |
| `description_changed` | 📝 | Изменение описания |
| `document_added` | 📎 | Добавление документа |
| `document_deleted` | 🗑️ | Удаление документа |
| `comment_added` | 💬 | Добавление комментария |
| `comment_edited` | ✏️ | Редактирование комментария |
| `comment_deleted` | 🗑️ | Удаление комментария |
| `checklist_item_added` | ☑️ | Добавление пункта чеклиста |
| `checklist_item_completed` | ✔️ | Отметка выполнения пункта |
| `checklist_item_uncompleted` | ⬜ | Снятие отметки выполнения |
| `checklist_item_edited` | ✏️ | Изменение пункта чеклиста |
| `checklist_item_deleted` | ❌ | Удаление пункта чеклиста |
| `checklist_item_reordered` | 🔀 | Изменение порядка чеклиста |
| `moved` | ↔️ | Перемещение задачи |
| `order_changed` | 🔀 | Изменение порядка |

## Технические детали

### Структура данных

```typescript
interface TaskHistoryItem {
  id: number;                  // ID записи истории
  taskId: number;              // ID задачи
  actionType: string;          // Тип действия
  fieldName?: string;          // Название изменённого поля
  oldValue?: string;           // Старое значение
  newValue?: string;           // Новое значение
  description: string;         // Описание действия
  dtc: string;                 // Дата/время создания
  userName?: string;           // Никнейм пользователя
  userFullName?: string;       // Полное имя пользователя
  actorUserId: number;         // ID пользователя, совершившего действие
  taskName: string;            // Название задачи
  taskDescription?: string;    // Описание задачи
  statusId: number;            // ID статуса
  statusName: string;          // Название статуса
  executorId?: number;         // ID исполнителя
  executorName?: string;       // Имя исполнителя
  priorityId?: number;         // ID приоритета
  priorityName?: string;       // Название приоритета
  projectName?: string;        // Название проекта
}
```

### Server Actions

#### `getAllTasksHistory(userId: number, limit: number = 50)`

Получает объединённую историю по всем задачам:

```typescript
// Пример использования
const tasksHistory = await getAllTasksHistory(currentUser.id, 100);
```

**Параметры:**

- `userId` - ID текущего пользователя (для будущей фильтрации)
- `limit` - максимальное количество записей (по умолчанию 50)

**SQL запрос:**

- Объединяет данные из `TaskHistory`, `Task`, `Users`, `TaskStatus`, `Employee`, `Priority`, `Project`
- Сортировка по дате создания (DESC)
- Исключает удалённые задачи (`WHERE t.id IS NOT NULL`)

### Компоненты

#### `InboxView`

- **Props**: `tasks`, `currentUserId`, `tasksHistory`
- **Функции**: Сортировка истории, рендеринг списка

#### `HistoryCard`

- **Props**: `item` (TaskHistoryItem), `currentUserId`
- **Функции**:
  - Определение типа выделения (назначено/завершено)
  - Выбор иконки для действия
  - Форматирование времени (относительное/абсолютное)

### Форматирование времени

```typescript
const formatTime = (dateString: string) => {
  const diffMins = // ...
  
  if (diffMins < 1) return 'только что';
  if (diffMins < 60) return `${diffMins} мин. назад`;
  if (diffHours < 24) return `${diffHours} ч. назад`;
  if (diffDays < 7) return `${diffDays} дн. назад`;
  
  return date.toLocaleDateString('ru-RU', { 
    day: 'numeric', 
    month: 'short', 
    hour: '2-digit', 
    minute: '2-digit' 
  });
}
```

## Навигация

Клик на любую карточку истории открывает соответствующую задачу в режиме редактирования:

```tsx
href={`/tasks/edit/${item.taskId}`}
```

## Примеры использования

### Сценарий 1: Отслеживание назначений

Пользователь может быстро увидеть все задачи, которые были назначены ему - они выделены синим фоном и имеют бейдж "Назначено вам".

### Сценарий 2: Мониторинг завершённых задач

Все завершённые задачи выделены зелёным фоном с бейджем "Завершено", что позволяет отслеживать прогресс работы команды.

### Сценарий 3: Общая активность

Полный список всех изменений позволяет видеть активность в проекте и понимать, что происходит с задачами в реальном времени.

## Будущие улучшения

1. **Фильтрация по типу действий** - возможность показывать только определённые типы изменений
2. **Фильтрация по проектам** - показывать историю только по выбранным проектам
3. **Группировка по датам** - "Сегодня", "Вчера", "Неделю назад"
4. **Пагинация** - загрузка истории по частям при прокрутке
5. **Отметка как прочитанное** - возможность отмечать события как просмотренные
6. **Уведомления** - счётчик непрочитанных событий

## Файлы

- `src/app/tasks/views/inbox/InboxView.tsx` - компонент отображения
- `src/app/tasks/actions/taskHistory.ts` - server actions для работы с историей
- `src/app/tasks/views/page.tsx` - загрузка данных
- `src/app/tasks/views/TaskViewLayout.tsx` - передача данных в InboxView
