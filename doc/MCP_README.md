# Model Context Protocol (MCP) для CRM1

## Описание

Этот проект реализует поддержку Model Context Protocol (MCP) для CRM системы. MCP позволяет AI-ассистентам безопасно взаимодействовать с данными CRM через стандартизированный протокол.

## Возможности

MCP сервер предоставляет доступ к следующим функциям CRM:

### Инструменты (Tools)

#### Задачи (Tasks)
- `task_list` - Получить список задач с фильтрацией
- `task_get` - Получить детальную информацию о задаче
- `task_search` - Поиск задач по названию/описанию
- `task_get_subtasks` - Получить подзадачи
- `task_get_history` - Получить историю изменений задачи

#### Клиенты (Clients)
- `client_list` - Получить список клиентов
- `client_get` - Получить информацию о клиенте
- `client_search` - Поиск клиентов

#### Проекты (Projects)
- `project_list` - Получить список проектов
- `project_get` - Получить информацию о проекте
- `project_search` - Поиск проектов
- `project_get_tasks` - Получить задачи проекта

#### Сотрудники (Employees)
- `employee_list` - Получить список сотрудников
- `employee_get` - Получить информацию о сотруднике
- `employee_search` - Поиск сотрудников

### Ресурсы (Resources)

- `crm://tasks/list` - Список всех задач
- `crm://tasks/{id}` - Конкретная задача
- `crm://projects/list` - Список всех проектов
- `crm://projects/{id}` - Конкретный проект
- `crm://clients/list` - Список всех клиентов
- `crm://clients/{id}` - Конкретный клиент

## Установка и настройка

### Предварительные требования

1. Node.js 20+
2. TypeScript 5+
3. Настроенная база данных MSSQL
4. Переменные окружения для подключения к БД

### Установка зависимостей

```bash
npm install
```

### Настройка переменных окружения

Убедитесь, что в вашем `.env.local` или `.env` файле указаны следующие переменные:

```env
DB_USER=ваш_пользователь
DB_PASSWORD=ваш_пароль
DB_SERVER=адрес_сервера
DB_NAME=имя_базы_данных
DB_PORT=1433
```

### Запуск MCP сервера

```bash
npm run mcp
```

Сервер использует stdio transport для коммуникации с MCP клиентами.

## Использование с AI-ассистентами

### Claude Desktop

1. Откройте конфигурационный файл Claude Desktop:
   - macOS: `~/Library/Application Support/Claude/claude_desktop_config.json`
   - Windows: `%APPDATA%\Claude\claude_desktop_config.json`

2. Добавьте конфигурацию сервера:

```json
{
  "mcpServers": {
    "crm1": {
      "command": "node",
      "args": [
        "--loader",
        "tsx",
        "/absolute/path/to/crm1/src/mcp/server.ts"
      ],
      "env": {
        "DB_USER": "your_user",
        "DB_PASSWORD": "your_password",
        "DB_SERVER": "your_server",
        "DB_NAME": "your_database",
        "DB_PORT": "1433"
      }
    }
  }
}
```

3. Перезапустите Claude Desktop

### Другие MCP клиенты

MCP сервер совместим с любыми клиентами, поддерживающими MCP protocol через stdio transport.

## Примеры использования

### Получение списка задач

```
Покажи мне все задачи со статусом "В работе"
```

AI-ассистент использует инструмент `task_list` с фильтром по statusId.

### Поиск клиента

```
Найди клиента с именем "Иванов"
```

AI-ассистент использует инструмент `client_search`.

### Просмотр деталей проекта

```
Покажи детали проекта с ID 5
```

AI-ассистент использует инструмент `project_get`.

## Безопасность

### Текущая реализация

- ✅ Валидация входных данных
- ✅ Параметризованные SQL запросы (защита от SQL injection)
- ✅ Ограничение размера результатов
- ✅ Использование существующих механизмов БД
- ⚠️ Нет аутентификации пользователей (планируется)
- ⚠️ Нет rate limiting (планируется)

### Рекомендации по безопасности

1. **Используйте в доверенной среде**: Текущая версия не включает аутентификацию. Запускайте только в защищённом окружении.

2. **Настройте переменные окружения**: Никогда не храните пароли в коде или конфигурационных файлах под контролем версий.

3. **Ограничьте права доступа к БД**: Используйте пользователя БД с минимально необходимыми правами (только SELECT для readonly операций).

4. **Мониторинг**: Следите за логами сервера для обнаружения подозрительной активности.

## Архитектура

```
src/mcp/
├── server.ts              # Основной MCP сервер
├── tools/                 # Инструменты (действия)
│   ├── tasks.ts          # Работа с задачами
│   ├── clients.ts        # Работа с клиентами
│   ├── projects.ts       # Работа с проектами
│   └── employees.ts      # Работа с сотрудниками
└── resources/            # Ресурсы (данные)
    ├── tasks.ts          # Ресурсы задач
    ├── projects.ts       # Ресурсы проектов
    └── clients.ts        # Ресурсы клиентов
```

## Разработка

### Добавление нового инструмента

1. Создайте или обновите файл в `src/mcp/tools/`
2. Добавьте определение инструмента в массив экспорта
3. Реализуйте обработчик инструмента
4. Добавьте инструмент в основной сервер (`server.ts`)

### Добавление нового ресурса

1. Создайте или обновите файл в `src/mcp/resources/`
2. Добавьте определение ресурса в массив экспорта
3. Реализуйте обработчик ресурса
4. Добавьте ресурс в основной сервер (`server.ts`)

## Тестирование

### Ручное тестирование

Вы можете протестировать MCP сервер используя MCP inspector:

```bash
npx @modelcontextprotocol/inspector node --loader tsx src/mcp/server.ts
```

### Автоматическое тестирование

(Планируется добавить)

## Ограничения

- **Только чтение**: Текущая версия поддерживает только чтение данных. Операции записи (создание, обновление, удаление) планируются в будущих версиях.
- **Нет аутентификации**: Сервер не выполняет аутентификацию запросов. Используйте в защищённой среде.
- **Лимиты результатов**: Максимальное количество возвращаемых записей ограничено для предотвращения перегрузки.

## Roadmap

### Планируемые улучшения

1. **Аутентификация и авторизация**
   - Интеграция с существующей системой iron-session
   - Проверка прав доступа к данным
   - Изоляция данных по компаниям

2. **Операции записи**
   - Создание задач, клиентов, проектов
   - Обновление существующих записей
   - Удаление записей

3. **Rate Limiting**
   - Защита от bruteforce атак
   - Ограничение частоты запросов

4. **Расширенные функции**
   - Работа с документами
   - Работа с чек-листами задач
   - Статистика и аналитика

5. **Тестирование**
   - Unit тесты
   - Integration тесты
   - E2E тесты

## Поддержка

При возникновении проблем:

1. Проверьте логи сервера
2. Убедитесь в правильности настройки переменных окружения
3. Проверьте доступность базы данных
4. Создайте issue в репозитории проекта

## Лицензия

Согласно лицензии основного проекта CRM1.

## Ссылки

- [Model Context Protocol Specification](https://modelcontextprotocol.io/)
- [MCP SDK Documentation](https://github.com/modelcontextprotocol/typescript-sdk)
- [Claude Desktop Configuration](https://docs.anthropic.com/claude/docs/model-context-protocol)
