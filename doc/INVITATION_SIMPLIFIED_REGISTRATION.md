# Упрощенная регистрация через приглашение

## Описание

Реализована упрощенная регистрация для пользователей, получивших приглашение по email. При переходе по ссылке из письма неавторизованные пользователи попадают на специальную страницу регистрации, где email уже подтвержден и зафиксирован.

## Основные изменения

### 1. Новый флоу регистрации через приглашение

**Путь:** `/register/invitation?token=<invitation-token>`

- Email уже подтвержден через приглашение
- Форма содержит только поля: полное имя и пароль
- Email отображается как заблокированное поле
- После регистрации автоматически создаются связи с компанией

### 2. Измененная логика приглашений

**Файл:** `src/app/employees/acceptinvitation/page.tsx`

- Неавторизованные пользователи перенаправляются на `/register/invitation?token=<token>` вместо обычной регистрации
- Авторизованные пользователи проходят стандартный процесс принятия приглашения

### 3. Новые компоненты

#### `src/app/(auth)/register/invitation/page.tsx`
- Серверный компонент для страницы регистрации через приглашение
- Проверяет токен приглашения
- Перенаправляет уже авторизованных пользователей обратно на принятие приглашения

#### `src/app/(auth)/register/invitation/InvitationRegisterForm.tsx`
- Клиентский компонент формы регистрации
- Email заблокирован и помечен как подтвержденный
- Отображает информацию о приглашении (роль, компания)

### 4. Новая server action

#### `registerWithInvitation` в `src/app/(auth)/actions/register.ts`

**Параметры:**
- `token: string` - токен приглашения
- `password: string` - пароль пользователя
- `fullName: string` - полное имя пользователя

**Логика:**
1. Проверяет валидность приглашения
2. Создает пользователя с `isVerified = 1` (email подтвержден через приглашение)
3. Создает запись в таблице `Employee`
4. Для роли `Partner` создает запись в `User_Company`
5. Помечает приглашение как принятое
6. Устанавливает сессию (cookie)

## Схема работы

```mermaid
graph TD
    A[Ссылка из email приглашения] --> B{Пользователь авторизован?}
    B -->|Нет| C[/register/invitation?token=xxx]
    B -->|Да| D[/employees/acceptinvitation?token=xxx]
    
    C --> E[Проверка токена]
    E -->|Валиден| F[Форма: имя + пароль]
    E -->|Невалиден| G[Ошибка приглашения]
    
    F --> H[registerWithInvitation]
    H --> I[Создать User с isVerified=1]
    I --> J[Создать Employee]
    J --> K{Роль Partner?}
    K -->|Да| L[Создать User_Company]
    K -->|Нет| M[Пропустить]
    L --> N[Пометить приглашение принятым]
    M --> N
    N --> O[Установить сессию]
    O --> P[Редирект на /dashboard]
    
    D --> Q[Стандартный флоу принятия]
```

## Безопасность

### ✅ Улучшения безопасности
1. **Email подтверждение через приглашение** - пользователь пришел из письма с валидным токеном, значит email подтвержден
2. **Автоматическая связка с компанией** - нет возможности зарегистрироваться в неправильной компании
3. **Контроль ролей** - роль определяется приглашением, пользователь не может выбрать роль самостоятельно

### ⚠️ Потенциальные улучшения
1. Добавить rate limiting на регистрацию через приглашения
2. Логирование всех попыток регистрации через приглашения
3. Возможность отозвать приглашение

## Тестирование

### Создание тестового приглашения
Выполните SQL скрипт `sql/create_test_invitation.sql` для создания тестовых приглашений.

### Тестовые сценарии

1. **Регистрация сотрудника**
   - URL: `/employees/acceptinvitation?token=test-invitation-token-12345`
   - Email: `test@example.com`
   - Ожидается: создание User + Employee

2. **Регистрация партнера**
   - URL: `/employees/acceptinvitation?token=test-invitation-partner-token-12345`
   - Email: `partner@example.com`
   - Ожидается: создание User + Employee + User_Company

3. **Невалидный токен**
   - URL: `/employees/acceptinvitation?token=invalid-token`
   - Ожидается: ошибка "Приглашение не найдено"

4. **Авторизованный пользователь**
   - Войти в систему, затем перейти по ссылке приглашения
   - Ожидается: стандартная форма принятия приглашения

## Структура файлов

```
src/app/
├── (auth)/
│   ├── register/
│   │   ├── invitation/
│   │   │   ├── page.tsx              # Страница регистрации через приглашение
│   │   │   └── InvitationRegisterForm.tsx  # Форма регистрации
│   │   └── ...
│   └── actions/
│       └── register.ts              # + registerWithInvitation action
├── employees/
│   └── acceptinvitation/
│       └── page.tsx                 # Измененная логика редиректа
└── ...

sql/
└── create_test_invitation.sql       # Скрипт для создания тестовых данных

doc/
└── INVITATION_SIMPLIFIED_REGISTRATION.md  # Этот файл
```

## API

### registerWithInvitation(token, password, fullName)

**Возвращает:**
```typescript
{
  success?: boolean;
  message?: string;
  error?: string;
}
```

**Пример успешного ответа:**
```javascript
{
  success: true,
  message: "Добро пожаловать в Argo Company! Вы успешно присоединились как сотрудник."
}
```

**Пример ошибки:**
```javascript
{
  error: "Приглашение не найдено"
}
```

## Совместимость

- ✅ Обратная совместимость: старые ссылки приглашений продолжают работать
- ✅ Существующий флоу принятия приглашений для авторизованных пользователей не изменился
- ✅ Обычная регистрация продолжает работать как прежде