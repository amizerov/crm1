# Миграция структуры медиафайлов

## Проблема
Старая структура использовала папку `public/projectdescription/{projectId}/`, новая использует `public/media/p{projectId}/`.

## Исправления

### 1. Исправлена ошибка в uploadDocument.ts
**Проблема:** `Cannot read properties of undefined (reading '0')`

**Причина:** Результат запроса MSSQL может возвращаться в разных форматах (массив или объект с recordset).

**Решение:**
```typescript
// Было:
const insertedId = (result as any).recordset[0]?.id;

// Стало:
const records = Array.isArray(result) ? result : (result as any).recordset || [];
const insertedId = records.length > 0 ? records[0]?.id : undefined;
```

### 2. Миграция файлов

#### Шаг 1: Запустить скрипт миграции
```bash
node scripts/migrate-media-structure.js
```

Скрипт:
- Копирует все изображения из `public/projectdescription/{projectId}/` в `public/media/p{projectId}/`
- Проверяет типы файлов (только изображения)
- Создаёт новые папки автоматически
- Не удаляет старые файлы (для безопасности)

#### Шаг 2: Проверить отображение изображений
- Откройте несколько проектов с изображениями в описании
- Убедитесь что все изображения загружаются корректно

#### Шаг 3: Обновить пути в БД (если требуется)
```sql
-- Проверить какие проекты используют старые пути
SELECT 
    id,
    projectName,
    description
FROM Project
WHERE description LIKE '%/projectdescription/%';

-- Если есть такие проекты, выполните обновление вручную
-- или используйте скрипт sql/migrate_media_paths.sql
```

#### Шаг 4: Удалить старую папку (после проверки)
```bash
# Windows PowerShell
Remove-Item -Recurse -Force public\projectdescription

# Linux/Mac
rm -rf public/projectdescription
```

## Новая структура папок

```
public/
└── media/
    ├── p4/                 # Проект с ID=4
    │   ├── 1730123456.png  # Изображение в описании проекта
    │   ├── doc_*.pdf       # Документ проекта
    │   └── t15/            # Задача с ID=15
    │       └── img_*.jpg   # Изображение/документ задачи
    └── p18/                # Проект с ID=18
        └── ...
```

## Преимущества новой структуры

1. ✅ **Единый стандарт** - все медиафайлы в одной папке `media/`
2. ✅ **Понятные префиксы** - `p{id}` для проектов, `t{id}` для задач
3. ✅ **Вложенность** - файлы задач находятся внутри папки проекта
4. ✅ **Масштабируемость** - легко добавить другие типы медиа
5. ✅ **Безопасность** - проще настроить права доступа на папку

## Текущее состояние

- ✅ `uploadImage.ts` - использует новую структуру
- ✅ `uploadDocument.ts` - использует новую структуру, ошибка исправлена
- ✅ `scanFiles.ts` - сканирует новую структуру
- ✅ Скрипт миграции готов
- ⚠️ Старые файлы нужно мигрировать вручную запуском скрипта
