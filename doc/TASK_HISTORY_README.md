# –ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á (Task History)

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞–¥–∞—á–∏ —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥ `logTaskHistory`.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –¢–∞–±–ª–∏—Ü–∞ TaskHistory

```sql
CREATE TABLE TaskHistory (
    id INT IDENTITY(1,1) PRIMARY KEY,
    taskId INT NOT NULL,
    userId INT NOT NULL,
    actionType NVARCHAR(50) NOT NULL,
    fieldName NVARCHAR(100),
    oldValue NVARCHAR(MAX),
    newValue NVARCHAR(MAX),
    description NVARCHAR(500),
    dtc DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (taskId) REFERENCES Task(id) ON DELETE CASCADE,
    FOREIGN KEY (userId) REFERENCES [User](id)
);
```

## –¢–∏–ø—ã –¥–µ–π—Å—Ç–≤–∏–π (actionType)

- `created` - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
- `status_changed` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
- `assigned` / `executor_changed` - –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
- `priority_changed` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
- `deadline_changed` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–µ–¥–ª–∞–π–Ω–∞
- `startdate_changed` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
- `name_changed` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
- `description_changed` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è
- `document_added` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- `document_deleted` - —É–¥–∞–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- `comment_added` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
- `comment_edited` - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
- `comment_deleted` - —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
- `moved` - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
- `updated` - –æ–±—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- `deleted` - —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ò–º–ø–æ—Ä—Ç

```typescript
import { logTaskHistory } from "@/app/tasks/actions/taskHistory";
```

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

```typescript
// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏
await logTaskHistory(taskId, {
  actionType: "created",
});

// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
await logTaskHistory(taskId, {
  actionType: "status_changed",
  fieldName: "status",
  oldValue: "To Do",
  newValue: "In Progress",
});

// –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
await logTaskHistory(taskId, {
  actionType: "document_added",
  newValue: fileName,
});

// –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
await logTaskHistory(taskId, {
  actionType: "document_deleted",
  oldValue: fileName,
});
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏—è

–§—É–Ω–∫—Ü–∏—è `generateHistoryDescription` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:

```typescript
// –í–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
description: '–∏–∑–º–µ–Ω–∏–ª(–∞) —Å—Ç–∞—Ç—É—Å —Å "To Do" –Ω–∞ "In Progress"'

// –ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—Ç—å —Ç–∏–ø –∏ –∑–Ω–∞—á–µ–Ω–∏—è
actionType: 'status_changed',
oldValue: 'To Do',
newValue: 'In Progress'
// –û–ø–∏—Å–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** - `src/app/tasks/actions/taskDocuments.ts`

- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (`document_added`)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (`document_deleted`)

### –ì–¥–µ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

üìù **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏** - `src/app/tasks/actions/updateTaskFromKanban.ts`

```typescript
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
if (oldTask.statusId !== newTask.statusId) {
  await logTaskHistory(taskId, {
    actionType: "status_changed",
    oldValue: oldTask.statusName,
    newValue: newTask.statusName,
  });
}

if (oldTask.executorId !== newTask.executorId) {
  await logTaskHistory(taskId, {
    actionType: "executor_changed",
    oldValue: oldTask.executorName || "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω",
    newValue: newTask.executorName || "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω",
  });
}

// –ò —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π...
```

üìù **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏** - –≥–¥–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–¥–∞—á–∞

```typescript
await logTaskHistory(newTaskId, {
  actionType: "created",
});
```

üìù **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏** - –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

```typescript
await logTaskHistory(taskId, {
  actionType: "comment_added",
});
```

## UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `src/app/tasks/views/common/TaskHistoryTab.tsx`

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ UI:

- Timeline —Å –∏–∫–æ–Ω–∫–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¥–µ–π—Å—Ç–≤–∏—è
- –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º –¥–µ–π—Å—Ç–≤–∏–π
- –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ ("5 –º–∏–Ω. –Ω–∞–∑–∞–¥", "2 —á. –Ω–∞–∑–∞–¥")
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∏ –Ω–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
- Responsive –¥–∏–∑–∞–π–Ω —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `sql/test_task_history.sql` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

```sql
-- –£–∫–∞–∂–∏—Ç–µ ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–¥–∞—á–∏
DECLARE @taskId INT = 456;
DECLARE @userId INT = 1;

-- –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—Å—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞

1. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è** - –æ–¥–∏–Ω –º–µ—Ç–æ–¥ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ** - –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç
3. **–¢–∏–ø–∏–∑–∞—Ü–∏—è** - TypeScript –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∏–ø—ã –¥–µ–π—Å—Ç–≤–∏–π
4. **–ì–∏–±–∫–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –¥–µ–π—Å—Ç–≤–∏–π
5. **–ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –∞—É–¥–∏—Ç–∞** - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ –≤—Ä–µ–º–µ–Ω–µ–º

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ —Ç–∏–ø–∞–º –¥–µ–π—Å—Ç–≤–∏–π
- [ ] –ü–æ–∏—Å–∫ –≤ –∏—Å—Ç–æ—Ä–∏–∏
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –≤ PDF/CSV
- [ ] –û—Ç–º–µ–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π (undo)
- [ ] –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π (diff)
- [ ] –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ —Å–µ—Å—Å–∏—è–º
