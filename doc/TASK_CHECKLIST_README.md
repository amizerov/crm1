# Чеклист задач (Task Checklist)

## Описание

Функционал чеклиста позволяет добавлять к задачам список подзадач или пунктов для выполнения. Чеклист отображается в панели "Действия" задачи, над комментариями.

## Структура базы данных

### Таблица TaskChecklist

```sql
CREATE TABLE TaskChecklist (
    id INT IDENTITY(1,1) PRIMARY KEY,
    taskId INT NOT NULL,
    description NVARCHAR(500) NOT NULL,
    isCompleted BIT NOT NULL DEFAULT 0,
    orderInList INT NOT NULL DEFAULT 0,
    userId INT NULL,
    dtc DATETIME2(3) NOT NULL DEFAULT GETDATE(),
    dtu DATETIME2(3) NULL,
    
    CONSTRAINT FK_TaskChecklist_Task FOREIGN KEY (taskId) 
        REFERENCES Task(id) ON DELETE CASCADE,
    CONSTRAINT FK_TaskChecklist_User FOREIGN KEY (userId) 
        REFERENCES Users(id) ON DELETE SET NULL
);
```

### Поля:
- `id` - уникальный идентификатор пункта
- `taskId` - ID задачи (с каскадным удалением)
- `description` - текст пункта чеклиста (до 500 символов)
- `isCompleted` - статус выполнения (true/false)
- `orderInList` - порядок отображения
- `userId` - кто создал пункт (nullable, SET NULL при удалении пользователя)
- `dtc` - дата создания (с точностью до миллисекунд)
- `dtu` - дата последнего обновления (nullable)

### Индексы:

```sql
-- Быстрая выборка по задаче
CREATE INDEX IX_TaskChecklist_TaskId 
    ON TaskChecklist(taskId, orderInList);

-- Сортировка пунктов
CREATE INDEX IX_TaskChecklist_Order 
    ON TaskChecklist(taskId, orderInList, id);
```

## Функционал

### 1. Добавление пункта
- Поле ввода над списком пунктов
- Enter или кнопка "Добавить" для сохранения
- Автоматическая установка порядкового номера в конец списка

### 2. Отметка выполнения
- Checkbox слева от каждого пункта
- Клик переключает статус
- Выполненные пункты отображаются зачеркнутым серым текстом

### 3. Редактирование текста
- Кнопка "Ред." появляется при наведении
- Inline редактирование
- Enter для сохранения, Escape для отмены
- Автоматическое обновление поля `dtu`

### 4. Удаление пункта
- Кнопка "Удал." появляется при наведении
- Подтверждение удаления
- Автоматическая перенумерация оставшихся пунктов

### 5. Изменение порядка
- Drag & Drop для перемещения пунктов
- Курсор `cursor-move` для визуального указания
- Подсветка целевой позиции при перетаскивании
- Автоматическая перенумерация после перемещения

### 6. Прогресс выполнения
- Счетчик "X / Y" в заголовке секции
- X - выполненных пунктов
- Y - всего пунктов

## Server Actions

### `getTaskChecklist(taskId: number)`
Получить все пункты чеклиста для задачи, отсортированные по `orderInList`.

### `addChecklistItem(taskId, description, userId)`
Добавить новый пункт в конец списка.

### `updateChecklistItem(itemId, description)`
Обновить текст пункта.

### `toggleChecklistItem(itemId, isCompleted)`
Переключить статус выполнения пункта.

### `deleteChecklistItem(itemId)`
Удалить пункт и перенумеровать оставшиеся.

### `reorderChecklistItems(taskId, itemId, newOrder)`
Изменить порядок пункта с автоматической перенумерацией соседних.

## UI/UX особенности

### Дизайн
- Скромный минималистичный дизайн без эмодзи
- Секция чеклиста расположена над комментариями
- Разделитель между чеклистом и комментариями
- Заголовки секций: "Чеклист" и "Комментарии"

### Truncate длинных текстов
- Однострочное отображение пунктов
- Автоматическое обрезание длинного текста с `truncate`
- Полный текст доступен через `title` при наведении

### Интерактивность
- Оптимистичные обновления UI
- Откат изменений при ошибке сервера
- Плавные анимации переходов
- Группированные кнопки действий (появляются при наведении)

### Доступность
- Keyboard navigation (Enter, Escape)
- Понятные placeholder'ы
- Disabled состояния кнопок
- Подтверждение удаления

## Оптимизация производительности

### Оптимистичные обновления
Все операции (добавление, редактирование, удаление, изменение порядка) применяются к UI немедленно, затем синхронизируются с сервером. При ошибке изменения откатываются.

### Батчинг запросов
При обновлении вкладки "Действия" чеклист и комментарии загружаются параллельно через `Promise.all()`.

### Индексы БД
Составные индексы на `(taskId, orderInList)` обеспечивают быструю выборку и сортировку пунктов.

## Примеры использования

### Создание чеклиста для задачи
```typescript
// Добавить пункты чеклиста
await addChecklistItem(taskId, "Согласовать требования", userId);
await addChecklistItem(taskId, "Написать код", userId);
await addChecklistItem(taskId, "Протестировать", userId);
```

### Отметить пункт выполненным
```typescript
await toggleChecklistItem(itemId, true);
```

### Изменить порядок
```typescript
// Переместить пункт с позиции 2 на позицию 0
await reorderChecklistItems(taskId, itemId, 0);
```

## Интеграция

Чеклист интегрирован в компонент `TaskActionsTab`, который рендерится в панели деталей задачи (`TaskDetails`).

Данные загружаются вместе с другими справочниками при открытии задачи:

```typescript
const [checklistData] = await Promise.all([
  getTaskChecklist(task.id),
  // ... другие данные
]);
```

## Будущие улучшения

- [ ] Шаблоны чеклистов для типовых задач
- [ ] Массовые операции (отметить все, удалить выполненные)
- [ ] Назначение ответственных на пункты чеклиста
- [ ] Уведомления при выполнении всех пунктов
- [ ] Статистика выполнения чеклистов
